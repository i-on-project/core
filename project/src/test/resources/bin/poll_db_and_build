#!/bin/sh

set -eu

timeout=120
start_time="$(date +%s)"
while true; do
  if psql -Atx "$(echo "$JDBC_DATABASE_URL" | sed 's;jdbc:;;g')" -1 -c "select" >/dev/null 2>/dev/null; then
    printf "Connection established with the database.\\n"
    break
  fi

  current_time="$(date +%s)"
  if [ "$(( current_time - start_time ))" -ge "$timeout" ]; then
    printf "Timeout reached. Exiting...\\n"
    exit 1
  fi
  sleep 1
done

container_name="core-migrate"
docker run --name "${container_name}" \
  -e JDBC_DATABASE_URL=${JDBC_DATABASE_URL} \
  --network host \
  --rm \
  "${container_name}" test

mkdir -p ~/.gradle && echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
./gradlew build --stacktrace --no-daemon

if [ $# -gt 0 ] && [ "$1" = "run" ]; then
  java -server \
    -jar "$(find build/libs -name "*.jar" | head -n 1)" \
    -Dserver.port=8080
fi
