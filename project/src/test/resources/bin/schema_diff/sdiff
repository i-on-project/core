#!/bin/sh

# Argument $1 == "apply" -> Apply the generated schema diff to the main DB
# Evvar $DEV_DB_URL -> URL to the dev DB
# Evvar $DB_URL     -> URL to the release DB

set -eu

# Poll for DB availability
# 1 minute of timeout
timeout=60
start_time="$(date +%s)"
printf "Attempting to connect to the database...\\n"
while true; do
  if psql -Atx "$DEV_DB_URL" -1 -c "select" >/dev/null 2>/dev/null; then
    printf "Connection established with the database.\\n"
    break
  fi
  printf "DB unavailable. Retrying...\\n"

  current_time="$(date +%s)"
  if [ "$(( current_time - start_time ))" -ge "$timeout" ]; then
    printf "Timeout reached. Exiting...\\n"
    exit 1
  fi
  sleep 1
done

schema_diff_file="/tmp/schema_diff"
scripts_dir="/mnt/sql"

# Test connection
psql -Atx "$DB_URL" -v "ON_ERROR_STOP=1" -1 -c "select" >/dev/null
psql -Atx "$DEV_DB_URL" -v "ON_ERROR_STOP=1" -1 -c "select" >/dev/null

printf "Building the most recent schema in the development DB.\n" >&2
cat "${scripts_dir}/drop-schema.sql" "${scripts_dir}/create-schema.sql" |\
  psql -Atx "$DEV_DB_URL" -v "ON_ERROR_STOP=1" -1 >&2

# Gen schema diff
# migra exits with 2 on success and 3 on error ._.
set +e
migra "$DB_URL" "$DEV_DB_URL" >"$schema_diff_file"
err="$?"
set -e

printf "\nGenerated patches for schema migration:\n"
cat "$schema_diff_file"
if [ "$err" != "2" ] && [ "$err" != "0" ]; then
  printf "Migration attempt failed. Aborting.\n"
  exit 1
fi

if [ "$#" != "0" ] && [ "$1" = "apply" ]; then
  cat "$schema_diff_file" "${scripts_dir}/insert-essential-data.sql" |\
    psql -Atx "$DB_URL" -v "ON_ERROR_STOP=1" -1 >&2
fi

